<!DOCTYPE html>
{{ users|json_script:"userdata" }}
{{ mmyyyy|json_script:"datedata" }}
{{ daySpan|json_script:"dayspandata" }}
<script>

// getting user preferences what hour the day starts and what hour it ends
const prepareNumbers = JSON.parse(document.getElementById('dayspandata').textContent);
const chosenDaySpan = JSON.parse(prepareNumbers);
const startHour = chosenDaySpan.start;
const endHour = chosenDaySpan.end;
const hoursRange = endHour - startHour;

// variable for the day selected. 0 if nothing selected.
let day_selected = 0;

// width of expanded day
const expandedDayWidth = 300;
let buildingSpace = document.getElementById("weeks-container");

const prepareString = JSON.parse(document.getElementById('userdata').textContent);
const allUsers = JSON.parse(prepareString);

const prepareDate = JSON.parse(document.getElementById('datedata').textContent);
const chosenMMYYYY = JSON.parse(prepareDate);

$(document).ready(function() {
    weekTables();

    // select a date column to expand
    $('.select-col').click(function() {

        // if already expanded, then collaps (unselect)
        if ($(this).parent().hasClass('expand-day')) {
            $(this).parent().removeClass('expand-day');
            $(this).find('div.expand-time').removeClass('show-timescale');
            $('.create-event-btn').addClass('btn-inactive');
            day_selected = 0;
        }
        else {
            $('.expand-day').removeClass('expand-day');
            $('.show-timescale').removeClass('show-timescale');
            $(this).parent().addClass('expand-day');
            $(this).find('div.expand-time').addClass('show-timescale');
            $('.create-event-btn').removeClass('btn-inactive');
            day_selected = $(this).find('span.day-display').text();
            $('#hidden-day').val(day_selected);
        }
        $(this).find('div.time-label').remove();
        x = expandedDayWidth / hoursRange; // for the with of the time grid
        for (let i = startHour; i < endHour; i++) {
            var el = '<div class="time-label" ' +
                'style="width: ' + x + 'px;">'+ i +
                 '</div>';
            $(this).find('div.expand-time').append(el);
        }
    });

    // modal view
    $('#myModal').on('shown.bs.modal', function () {
        $('#myInput').trigger('focus')
    })
});


let calendarLabels = {
    weekDays: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
    allMonths: ["January", "February", "March", "April", "Mai", "June", "July", "August", "September", "October", "November", "December"]
};

function weekTables() {

    let dateReference = getDate();
    let loopDate = getDate();
    loopDate.setDate(1);

    let cssGrid = document.createElement('div');
    cssGrid.classList.add('month-table');
    buildingSpace.appendChild(cssGrid);

    // build the left column
    let colLeft = document.createElement('div');
    colLeft.classList.add('table-column', 'table-col-fixed');
    cssGrid.appendChild(colLeft);

    let colLeftTitle = document.createElement('div');
    colLeftTitle.classList.add('table-header');
    colLeftTitle.innerHTML = '<div class="name-label">Name</div>';
    colLeft.appendChild(colLeftTitle);

    for (let i = 0; i < allUsers.length; i++) {
        let userLabel = document.createElement('div');
        userLabel.classList.add('table-cell');
        if (i % 2 == 0) {
                userLabel.classList.add('even-row');
            }
        url = `/planning/summary/${allUsers[i].pk}`
        userLabel.innerHTML = `<a href="${url}">${allUsers[i].fields.first_name} ${allUsers[i].fields.last_name}</a>`;
        colLeft.appendChild(userLabel);
    }

    // make sure only one month is drawn
    while (loopDate.getMonth() == dateReference.getMonth()) {

        // create a new column
        let dayColumn = document.createElement('div');
        dayColumn.classList.add('table-column');
        cssGrid.appendChild(dayColumn);

        // column header (date)
        let dayColumnHead = document.createElement('div');
        dayColumnHead.classList.add('table-header');
        dayColumnHead.classList.add('select-col'); // reaction to click
        dayColumnHead.innerHTML = '<a href="#!"><span class="hday">' +
            calendarLabels.weekDays[loopDate.getDay()] + '</span>' + 
            '<span class="day-display">' + loopDate.getDate() + '</span>' + 
            '<div class="expand-time"></div></a>';
        dayColumn.appendChild(dayColumnHead);

        // create all the cells
        for (let i = 0; i < allUsers.length; i++) {
            let cell = document.createElement('div');
            cell.classList.add('table-cell');
            if (i % 2 == 0) {
                cell.classList.add('even-row');
            }
            if (loopDate.getDay() == 0) {
                cell.classList.add('neweek-border');
                if (i == 0) {
                    cell.innerText = loopDate.getWeek();
                    cell.classList.add('week-number');
                }
            }
            dayColumn.appendChild(cell);
        }
        loopDate.setDate(loopDate.getDate() + 1); 
    }
}

function getDate() {
    let today = new Date()
    let chosenDate = new Date();
    chosenDate.setMonth(chosenMMYYYY.month);
    chosenDate.setYear(chosenMMYYYY.year);

    let monthTitle = document.getElementById("month-title");

    // add the year to the title if outside the current year
    if (today.getFullYear() === chosenDate.getFullYear()){
        monthTitle.innerHTML = calendarLabels.allMonths[chosenDate.getMonth()];
    } else {
        monthTitle.innerHTML = calendarLabels.allMonths[chosenDate.getMonth()] + " " + chosenDate.getFullYear();
    }
    return chosenDate;
}

// get the calendarweek-number
Date.prototype.getWeek = function() {
    var onejan = new Date(this.getFullYear(), 0, 1);
    return Math.ceil((((this - onejan) / 86400000) + onejan.getDay() + 1) / 7);
}

</script>